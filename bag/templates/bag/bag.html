{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container py-5">
  <h2 class="mb-4 text-center">Your Shopping Bag</h2>

  {% if bag_items %}
    <div class="table-responsive mb-4">
      <table class="table table-striped text-center">
        <thead class="thead-dark">
          <tr>
            <th scope="col">Product</th>
            <th scope="col">Price (‚Çµ)</th>
            <th scope="col">Quantity</th>
            <th scope="col">Subtotal (‚Çµ)</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          {% for item in bag_items %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                {% if item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" width="60" class="mr-3 rounded">
                {% else %}
                  <img src="{% static 'img/noimage.png' %}" alt="No image" width="60" class="mr-3 rounded">
                {% endif %}
                <div class="text-left">
                  <strong>{{ item.product.name }}</strong><br>
                  {% if item.size %}
                    <small>Size: {{ item.size }}</small>
                  {% endif %}
                </div>
              </div>
            </td>

            <td>{{ item.product.price }}</td>

            <td>
              <form action="{% url 'adjust_bag' item.item_id %}" method="POST" class="d-inline">
                {% csrf_token %}
                <div class="input-group input-group-sm">
                  <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99"
                    class="form-control text-center" style="width:70px;">
                  {% if item.size %}
                    <input type="hidden" name="product_size" value="{{ item.size }}">
                  {% endif %}
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="submit">Update</button>
                  </div>
                </div>
              </form>
            </td>

            <td>{{ item.quantity|floatformat:0|add:item.product.price|floatformat:2 }}</td>

            <td>
              <form action="{% url 'remove_from_bag' item.item_id %}" method="POST" class="d-inline">
                {% csrf_token %}
                {% if item.size %}
                  <input type="hidden" name="product_size" value="{{ item.size }}">
                {% endif %}
                <button type="submit" class="btn btn-danger btn-sm">Remove</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Bag Summary -->
    <div class="card shadow-sm p-4">
      <h4 class="mb-3">Order Summary</h4>
      <p><strong>Items:</strong> {{ product_count }}</p>
      <p><strong>Total:</strong> ‚Çµ{{ total|floatformat:2 }}</p>

      {% if free_delivery_delta > 0 %}
        <p class="text-info">
          Spend ‚Çµ{{ free_delivery_delta|floatformat:2 }} more to get <strong>free delivery!</strong>
        </p>
        <a href="{% url 'all_products' %}" class="btn btn-outline-secondary mb-2">
          Continue Shopping
        </a>
        <a href="{% url 'checkout' %}" class="btn btn-primary mb-2">
          Secure Checkout
        </a>
      {% else %}
        <p class="text-success">
          You‚Äôve qualified for <strong>free delivery üéâ</strong>
        </p>
      {% endif %}

      <hr>
      <h5>Grand Total: ‚Çµ{{ grand_total|floatformat:2 }}</h5>

      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'all_products' %}" class="btn btn-outline-secondary">
          <i class="fas fa-chevron-left"></i> Continue Shopping
        </a>
        <a href="{% url 'checkout' %}" class="btn btn-primary">
          <i class="fas fa-lock"></i> Secure Checkout
        </a>
      </div>
    </div>

  {% else %}
    <div class="text-center py-5">
      <h4>Your bag is empty üõçÔ∏è</h4>
      <p class="mt-3">
        <a href="{% url 'products' %}" class="btn btn-outline-primary">
          Browse Products
        </a>
      </p>
    </div>
  {% endif %}
</div>

{% endblock %}
